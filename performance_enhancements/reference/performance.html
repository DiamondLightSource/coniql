<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performance &mdash; coniql 0.4.dev75+g3013983 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/coniql-favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Contributing" href="contributing.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: rgb(7, 43, 93)" >

          
          
          <a href="../index.html" class="icon icon-home">
            coniql
              <img src="../_static/coniql-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                master
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/run-a-server.html">Run a server</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/why-graphql.html">Why GraphQL?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmark.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Performance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#investigating-coniql-performance">Investigating Coniql Performance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#method">Method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#findings">Findings</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/DiamondLightSource/coniql/releases">Releases</a></li>
<li class="toctree-l1"><a class="reference external" href="genindex.html#http://">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: rgb(7, 43, 93)" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">coniql</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Performance</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/reference/performance.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="performance">
<h1>Performance<a class="headerlink" href="#performance" title="Permalink to this heading"></a></h1>
<p>Coniql has had much work done to have the best performance for Subscriptions, which are the primary use case
of most web GUIs, who are the primary consumers of Coniql data.</p>
<p>Coniql can handle approximately 2,000 updates per second. This was tested using 10Hz PVs, subscribing to
increasing numbers until updates were no longer being sent promptly.</p>
<section id="investigating-coniql-performance">
<h2>Investigating Coniql Performance<a class="headerlink" href="#investigating-coniql-performance" title="Permalink to this heading"></a></h2>
<section id="method">
<h3>Method<a class="headerlink" href="#method" title="Permalink to this heading"></a></h3>
<p>The primary method used for investigating Coniql’s performance has been <a class="reference external" href="https://github.com/benfred/py-spy">py-spy</a>.
This is a sampling profiler that can output speedscope-format data, which can then be viewed in the very nice
<a class="reference external" href="https://www.speedscope.app/">Speedscope web UI</a>.</p>
<p>The profiles have been generates by first installing  <code class="docutils literal notranslate"><span class="pre">py-spy</span></code>, then running the <a class="reference internal" href="benchmark.html"><span class="doc">Benchmarking</span></a> tests,
modifying the Bash script to launch  <code class="docutils literal notranslate"><span class="pre">py-spy</span></code>, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CMD2</span><span class="o">=</span><span class="s2">&quot;sleep 2;source $CONIQL_DIR/bin/activate;py-spy record --format speedscope --output speedscope-$(date +&quot;</span><span class="o">%</span><span class="n">Y</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">d</span><span class="o">-%</span><span class="n">H</span><span class="p">:</span><span class="o">%</span><span class="n">M</span><span class="p">:</span><span class="o">%</span><span class="n">S</span><span class="s2">&quot;) coniql&quot;</span>
</pre></div>
</div>
<p>An example speedscope can be found in this directory.</p>
</section>
<section id="findings">
<h3>Findings<a class="headerlink" href="#findings" title="Permalink to this heading"></a></h3>
<p>Most of the time spent in processing results is done using <code class="docutils literal notranslate"><span class="pre">async</span></code> processing. The major performance gains so far have all come from
minimizing the amount of <code class="docutils literal notranslate"><span class="pre">async</span></code> calls that are made in our code. For example all of our Resolvers are now synchronous.
We do have to have some <code class="docutils literal notranslate"><span class="pre">async</span></code> calls, as we must use <code class="docutils literal notranslate"><span class="pre">aioca</span></code> to monitor PVs. These occur on initial calls to Query, Mutations,
and Subscriptions, in a stage before the Resolvers are called.</p>
<p>The current sampling shows that 80% of the time is spent in <code class="docutils literal notranslate"><span class="pre">operation_task()</span></code>, which is a high level function inside Strawberry.
This code calls into the lower level <code class="docutils literal notranslate"><span class="pre">graphql</span></code> library for most of its runtime. Broadly, these calls handle the GraphQL protocol,
parsing the requested fields into calls to our library for data, then parsing that data back out to return the requested fields
to the client.</p>
<p>It is unclear why exactly this process seems to have so much overhead - further investigation is required.</p>
<p>Approxmately 1% of time is spent directly in Coniql code. Most of that is inside of the <code class="docutils literal notranslate"><span class="pre">aioca</span></code> callbacks. Additional performance gains in this
area are unlikely to be worthwhile as the possible gains are so small.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="contributing.html" class="btn btn-neutral float-left" title="Contributing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
   
  <div id="other-versions-div" class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions" style="visibility: hidden">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Other Versions</span>
      master
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl id="other-versions-dl"/>
    </div>
  </div>
  <script>
    function addVersion(name) {
      var dd = document.createElement("dd");
      var a = document.createElement("a");
      a.href = "../../" + name;
      a.innerText = name;
      dd.appendChild(a);
      document.getElementById('other-versions-dl').appendChild(dd);
    }
    // Get versions.txt and add a version for each line
    fetch("../../versions.txt").then(response => {
      if (response.ok) {
        document.getElementById('other-versions-div').style.visibility = "visible";
        return response.text().then(text => text.split(/\r?\n/).forEach(addVersion))
      }
    });
  </script>


</body>
</html>